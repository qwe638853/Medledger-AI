syntax = "proto3";

package health;

option go_package = "sdk_test/proto;health"; 

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";

service HealthService {
  rpc UploadReport(UploadReportRequest) returns (UploadReportResponse){
    option (google.api.http) = {
      post: "/v1/upload"
      body: "*"
    };
  }
  rpc ClaimReport(ClaimReportRequest) returns (ClaimReportResponse) {
    option (google.api.http) = {
      post: "/v1/claim"
      body: "*"
    };
  }

  rpc ReadReport(ReadReportRequest) returns (ReadReportResponse) {
    option (google.api.http) = {
      get: "/v1/report/{report_id}"
    };
  }

  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/v1/login"
      body: "*"
    };
  }
  rpc RegisterUser(RegisterUserRequest) returns (RegisterResponse) {
    option (google.api.http) = {
      post: "/v1/register/user"
      body: "*"
    };
  }

  rpc RegisterInsurer(RegisterInsurerRequest) returns (RegisterResponse) {
    option (google.api.http) = {
      post: "/v1/register/insurer"
      body: "*"
    };
  }
  rpc ListMyReports(google.protobuf.Empty) returns (ListMyReportsResponse) {
    option (google.api.http) = {
      get: "/v1/reports"
    };
  }

  rpc RequestAccess(RequestAccessRequest) returns (RequestAccessResponse) {
    option (google.api.http) = {
      post: "/v1/access/request"
      body: "*"
    };
  }

  rpc ListAccessRequests(google.protobuf.Empty) returns (ListAccessRequestsResponse) {
    option (google.api.http) = {
      get: "/v1/access/requests"
    };
  }

  rpc ApproveAccessRequest(ApproveAccessRequestRequest) returns (ApproveAccessRequestResponse) {
    option (google.api.http) = {
      post: "/v1/access/approve"
      body: "*"
    };
  }

  rpc RejectAccessRequest(RejectAccessRequestRequest) returns (RejectAccessRequestResponse) {
    option (google.api.http) = {
      post: "/v1/access/reject"
      body: "*"
    };
  }

  rpc GetInsurerDashboardStats(google.protobuf.Empty) returns (InsurerDashboardStatsResponse) {
    option (google.api.http) = {
      get: "/v1/dashboard/summary"
    };
  }
  rpc ListAuthorizedReports(google.protobuf.Empty) returns (ListAuthorizedReportsResponse) {
    option (google.api.http) = {
      get: "/v1/reports/authorized"
    };
  }

  rpc ListReportMetaByPatientID(PatientIDRequest) returns (ListReportMetaResponse) {
    option (google.api.http) = {
      get: "/v1/reports/meta/{patient_id}"
    };
  }

  // çµ¦ç”¨æˆ¶çš„å¥åº·å ±å‘Šåˆ†æ
  rpc AnalyzeHealthReportForUser(AnalyzeHealthReportRequest) returns (UserHealthAnalysisResponse) {
    option (google.api.http) = {
      post: "/v1/analyze/user"
      body: "*"
    };
  }

  // çµ¦ä¿éšªå…¬å¸çš„å¥åº·å ±å‘Šåˆ†æ
  rpc AnalyzeHealthReportForInsurer(AnalyzeHealthReportRequest) returns (InsurerHealthAnalysisResponse) {
    option (google.api.http) = {
      post: "/v1/analyze/insurer"
      body: "*"
    };
  }
}

message UploadReportRequest {
  string report_id = 1;
  string user_id = 2;
  string test_results_json = 3;
}

message UploadReportResponse {
    bool success = 1;
    string message = 2;
}

message ClaimReportRequest {
  string report_id = 1;
}

message ClaimReportResponse {
  bool success = 1;
  string message = 2;
}

message ReadReportRequest {
  string report_id = 1;
}

message ReadReportResponse {
  bool success = 1;
  string report_content = 2;
}

message LoginRequest {
  string user_id = 1;
  string password = 2;
}

message LoginResponse {
    bool success = 1;
    string message = 2;
    string token = 3; 
}

message RegisterUserRequest {
  string user_id = 1;
  string password = 2;
  string name = 3;
  string date = 4;
  string email = 5;
  string phone = 6;
}

message RegisterInsurerRequest {
  string insurer_id = 1;      // ä¾‹å¦‚: CATHAY-01
  string password = 2;
  string company_name = 3;
  string contact_person = 4;
  string email = 5;
  string phone = 6;
}

message RegisterResponse {
    bool success = 1;
    string message = 2;
}

message Report {
  string report_id = 1;
  string clinic_id = 2;
  string patient_hash = 3; 
  string result_json = 4;
  int64 created_at = 5;
}

message ListMyReportsResponse {
  repeated Report reports = 1;
}

// ğŸ”µ ä¿éšªæ¥­è€…é€å‡ºæˆæ¬Šç”³è«‹
message RequestAccessRequest {
  string report_id = 1;
  string patient_id = 2;
  string reason = 3;
  int64 expiry = 4; // Unix ç§’
}

message RequestAccessResponse {
  bool success = 1;
  string request_id = 2; // optional: å›å‚³ç”³è«‹å–® ID
}

// ğŸŸ¢ ç—…æ‚£æŸ¥è©¢è‡ªå·±çš„å¾…å¯©ç”³è«‹
message AccessRequest {
  string request_id = 1;
  string report_id = 2;
  string patient_hash = 3;
  string target_hash = 4;
  string reason = 5;
  int64 requested_at = 6;
  int64 expiry = 7;
  string status = 8; // pending / approved / rejected
}

message ListAccessRequestsResponse {
  repeated AccessRequest requests = 1;
}

// ğŸŸ¡ ç—…æ‚£é»åŒæ„æˆæ¬Š
message ApproveAccessRequestRequest {
  string request_id = 1;
}

message ApproveAccessRequestResponse {
  bool success = 1;
  string message = 2;
}

// ğŸ”´ ç—…æ‚£æ‹’çµ•æˆæ¬Š
message RejectAccessRequestRequest {
  string request_id = 1;
}

message RejectAccessRequestResponse {
  bool success = 1;
  string message = 2;
}

enum AccessRequestStatus {
  PENDING = 0;
  APPROVED = 1;
  REJECTED = 2;
}

message InsurerDashboardStatsResponse {
  int32 total_authorized = 1;
  int32 pending_requests = 2;
  int32 total_patients = 3;
}

message AuthorizedReport {
  string report_id = 1;
  string patient_id = 2;
  string content = 3;
  string date = 4;
  string expiry = 5;
}

message ListAuthorizedReportsResponse {
  repeated AuthorizedReport reports = 1;
}

message PatientIDRequest {
  string patient_id = 1;
}

message ReportMeta {
  string report_id = 1;
  string clinic_id = 2;
  int64 created_at = 3;
}

message ListReportMetaResponse {
  repeated ReportMeta reports = 1;
}

// å¥åº·å ±å‘Šåˆ†æçš„è«‹æ±‚æ¶ˆæ¯
message AnalyzeHealthReportRequest {
  string report_id = 1;
  string patient_hash = 2;
  string test_results_json = 3;  // å¥åº·æª¢æŸ¥çµæœçš„ JSON å­—ç¬¦ä¸²
}

// çµ¦ç”¨æˆ¶çœ‹çš„å¥åº·åˆ†æéŸ¿æ‡‰
message UserHealthAnalysisResponse {
  string summary = 1; // å¥åº·å ±å‘Šç¸½çµï¼Œä¾‹å¦‚ "ä½ çš„è¡€å£“åé«˜ï¼Œå»ºè­°..."
  string advice = 2; // å¥åº·å»ºè­°ï¼Œä¾‹å¦‚ "å»ºè­°å¤šé‹å‹•ï¼Œæ¸›å°‘é¹½åˆ†æ”å…¥"
  optional bool success = 3;
  optional string recommended_policy = 4; // æ¨è–¦çš„ä¿å–®é¡å‹ï¼Œä¾‹å¦‚ "æ¨™æº–å¥åº·ä¿å–®"
}

// çµ¦ä¿éšªå…¬å¸çœ‹çš„å¥åº·åˆ†æéŸ¿æ‡‰
message InsurerHealthAnalysisResponse {
  string summary = 1; // å¥åº·å ±å‘Šç¸½çµï¼Œä¾‹å¦‚ "è¡€å£“ 150/90ï¼Œè¡€ç³– 130 mg/dL"
  string metrics = 2; // å¥åº·ç‹€æ…‹ï¼Œä¾‹å¦‚ "æ­£å¸¸" æˆ– "ç•°å¸¸"
  repeated Risk risks = 3; // ç–¾ç—…é¢¨éšªåˆ—è¡¨
  string policy_type = 4; // æ¨è–¦çš„ä¿å–®é¡å‹ï¼Œä¾‹å¦‚ "é«˜é¢¨éšªä¿å–®"
  optional bool success = 5;
  optional string insurance_suitability = 6; // æ‰¿ä¿å»ºè­°ï¼Œä¾‹å¦‚ "é«˜é¢¨éšªï¼Œå»ºè­°æé«˜ä¿è²»"
}

// ç–¾ç—…é¢¨éšªçµæ§‹
message Risk {
  string disease = 1; // ç–¾ç—…åç¨±ï¼Œä¾‹å¦‚ "é«˜è¡€å£“"
  string description = 2; // é¢¨éšªæè¿°ï¼Œä¾‹å¦‚ "è¡€å£“é•·æœŸåé«˜ï¼Œå»ºè­°é†«ç™‚è¿½è¹¤"
  string impact = 3; // æ½›åœ¨å½±éŸ¿ï¼Œä¾‹å¦‚ "å¯èƒ½å°è‡´å¿ƒè¡€ç®¡ç–¾ç—…"
}